# sstable-to-arrow

## How to run

This project can be run through a Docker container via
```bash
docker build -t sstable-to-arrow .
# the following assumes that Docker can access the filesystem you're running this on
docker run --rm -itp 9143:9143 --name sstable-to-arrow sstable-to-arrow <PATH_TO_SSTABLE_DIRECTORY>
```
With the VS Code [Remote - Containers](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers) extension installed, you can also open this folder in VS Code, run `Open Folder in Container` from the command palette, and select this folder to run the project within a Docker container.

If not using Docker, you can manually build the project as follows, though installation of dependencies may vary from machine to machine.

1. This project depends on [Kaitai Struct](`https://kaitai.io/#download`), the [Kaitai Struct C++/STL runtime library](https://github.com/kaitai-io/kaitai_struct_cpp_stl_runtime), and [Apache Arrow for C++](http://arrow.apache.org/docs/cpp/cmake.html). If you are manually building Arrow and using other Arrow features like the filesystem interface `arrow::fs`, make sure to check [if you need to include any optional components](http://arrow.apache.org/docs/developers/cpp/building.html#optional-components). **This project requires `-DARROW_COMPUTE=ON`.** See the `RUN` commands in the [`Dockerfile`](Dockerfile) for an example.

2. Get (an) SSTable(s). You can download IOT (Internet of Things) sample data generated by [NoSQLBench](http://docs.nosqlbench.io/#/) [at this Google Drive folder](https://drive.google.com/drive/folders/1y-f6rRH3OfC8AvVTNuhcmvjihnaMWN4p?usp=sharing). You can also generate IOT data using the script at [../test/generate-data](../test/generate-data), or you can manually create a table using CQL and the Cassandra Docker image using the steps below. See [the Cassandra quickstart](https://cassandra.apache.org/quickstart/) for more info.

```bash
docker network create cassandra
docker run --rm -d --name cassandra --hostname cassandra --network cassandra cassandra:3.11
# Run a CQL query to create the data. You may need to wait for the server to start up before running this.
# If you have a CQL query in a file, run:
# docker run --rm --network cassandra -v "<LOCAL_PATH_TO_CQL_FILE>:/scripts/data.cql" -e CQLSH_HOST=cassandra -e CQLSH_PORT=9042 nuvo/docker-cqlsh
# To open a CQL shell on the container, run:
# docker run --rm -it --network cassandra nuvo/docker-cqlsh cqlsh cassandra 9042 --cqlversion='3.4.4'
docker exec cassandra /opt/cassandra/bin/nodetool flush
docker cp cassandra:/var/lib/cassandra/data/<YOUR_KEYSPACE> ./res
# clean up
docker kill cassandra
docker network rm cassandra
```

3. Compile as follows:

```bash
mkdir build
cd build
cmake .. # or if using ninja: cmake -GNinja ..
make # or: ninja
```

4. Run:

```bash
./sstable_to_arrow <PATH_TO_SSTABLE_DIRECTORY>
```
